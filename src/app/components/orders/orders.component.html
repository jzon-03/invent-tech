<div class="orders-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Order Management</h1>
      <p>Track and manage purchase orders, deliveries, and supplier transactions</p>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="openCreateOrderDialog()">
        <mat-icon>add_shopping_cart</mat-icon>
        Create Order
      </button>
      <button mat-stroked-button [matMenuTriggerFor]="moreMenu">
        <mat-icon>more_vert</mat-icon>
        More
      </button>
      <mat-menu #moreMenu="matMenu">
        <button mat-menu-item (click)="exportOrders()">
          <mat-icon>download</mat-icon>
          <span>Export Orders</span>
        </button>
        <button mat-menu-item (click)="importOrders()">
          <mat-icon>upload</mat-icon>
          <span>Import Orders</span>
        </button>
        <button mat-menu-item (click)="generatePOReport()">
          <mat-icon>receipt</mat-icon>
          <span>PO Report</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="bulkCancel()" [disabled]="selection.selected.length === 0">
          <mat-icon>cancel</mat-icon>
          <span>Cancel Selected</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-row">
    <mat-card class="stat-card">
      <mat-card-header>
        <mat-icon mat-card-avatar color="primary">shopping_cart</mat-icon>
        <mat-card-title>Total Orders</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <h2>{{getTotalOrders()}}</h2>
        <div class="stat-detail">{{getThisMonthOrders()}} this month</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-header>
        <mat-icon mat-card-avatar color="accent">local_shipping</mat-icon>
        <mat-card-title>Pending Orders</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <h2 class="pending-count">{{getPendingOrders()}}</h2>
        <div class="stat-detail">Awaiting delivery</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-header>
        <mat-icon mat-card-avatar style="color: #4caf50;">attach_money</mat-icon>
        <mat-card-title>Total Value</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <h2>${{getTotalValue().toLocaleString()}}</h2>
        <div class="stat-detail positive">+12% from last month</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-header>
        <mat-icon mat-card-avatar color="warn">schedule</mat-icon>
        <mat-card-title>Overdue</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <h2 class="overdue-count">{{getOverdueOrders()}}</h2>
        <div class="stat-detail">Need attention</div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Quick Filters -->
  <div class="quick-filters">
    <mat-chip-set aria-label="Order Status Filter">
      <mat-chip-option [selected]="quickFilter === ''" (click)="setQuickFilter('')">
        All ({{orders.length}})
      </mat-chip-option>
      <mat-chip-option [selected]="quickFilter === 'pending'" (click)="setQuickFilter('pending')">
        Pending ({{getOrdersByStatus('pending').length}})
      </mat-chip-option>
      <mat-chip-option [selected]="quickFilter === 'confirmed'" (click)="setQuickFilter('confirmed')">
        Confirmed ({{getOrdersByStatus('confirmed').length}})
      </mat-chip-option>
      <mat-chip-option [selected]="quickFilter === 'shipped'" (click)="setQuickFilter('shipped')">
        Shipped ({{getOrdersByStatus('shipped').length}})
      </mat-chip-option>
      <mat-chip-option [selected]="quickFilter === 'delivered'" (click)="setQuickFilter('delivered')">
        Delivered ({{getOrdersByStatus('delivered').length}})
      </mat-chip-option>
      <mat-chip-option [selected]="quickFilter === 'cancelled'" (click)="setQuickFilter('cancelled')">
        Cancelled ({{getOrdersByStatus('cancelled').length}})
      </mat-chip-option>
    </mat-chip-set>
  </div>

  <!-- Search and Filters -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-row">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search orders</mat-label>
          <input matInput placeholder="Search by PO number, supplier, or items" [(ngModel)]="searchTerm" (input)="applyFilter()">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select [(ngModel)]="statusFilter" (selectionChange)="applyFilter()">
            <mat-option value="">All Status</mat-option>
            <mat-option value="pending">Pending</mat-option>
            <mat-option value="confirmed">Confirmed</mat-option>
            <mat-option value="shipped">Shipped</mat-option>
            <mat-option value="delivered">Delivered</mat-option>
            <mat-option value="cancelled">Cancelled</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Supplier</mat-label>
          <mat-select [(ngModel)]="supplierFilter" (selectionChange)="applyFilter()">
            <mat-option value="">All Suppliers</mat-option>
            <mat-option *ngFor="let supplier of getUniqueSuppliers()" [value]="supplier">
              {{supplier}}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Date Range</mat-label>
          <mat-select [(ngModel)]="dateFilter" (selectionChange)="applyFilter()">
            <mat-option value="">All Time</mat-option>
            <mat-option value="today">Today</mat-option>
            <mat-option value="week">This Week</mat-option>
            <mat-option value="month">This Month</mat-option>
            <mat-option value="quarter">This Quarter</mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-button (click)="clearFilters()" class="clear-filters">
          <mat-icon>clear</mat-icon>
          Clear
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Orders Content -->
  <div class="orders-container">
    <!-- View Toggle -->
    <div class="view-controls">
      <mat-button-toggle-group [(ngModel)]="viewMode" class="view-toggle">
        <mat-button-toggle value="cards">
          <mat-icon>view_module</mat-icon>
        </mat-button-toggle>
        <mat-button-toggle value="table">
          <mat-icon>view_list</mat-icon>
        </mat-button-toggle>
      </mat-button-toggle-group>

      <span class="results-count">{{getFilteredOrders().length}} orders</span>
    </div>

    <!-- Cards View -->
    <div *ngIf="viewMode === 'cards'" class="orders-grid">
      <mat-card *ngFor="let order of getFilteredOrders()" 
                class="order-card"
                [class.selected]="selection.isSelected(order)"
                [class]="getOrderCardClass(order)"
                (click)="selectOrder(order)">
        
        <!-- Selection Checkbox -->
        <div class="card-selection">
          <mat-checkbox [checked]="selection.isSelected(order)"
                        (change)="toggleSelection(order)"
                        (click)="$event.stopPropagation()">
          </mat-checkbox>
        </div>

        <!-- Order Header -->
        <mat-card-header>
          <div class="order-header-info">
            <mat-card-title>{{order.poNumber}}</mat-card-title>
            <mat-card-subtitle>{{order.supplier}}</mat-card-subtitle>
          </div>
          <div class="order-status">
            <mat-chip [class]="getStatusChipClass(order.status)">{{order.status | titlecase}}</mat-chip>
          </div>
        </mat-card-header>

        <mat-card-content>
          <div class="order-details">
            <div class="detail-row">
              <mat-icon>event</mat-icon>
              <span>Order Date: {{order.orderDate | date:'mediumDate'}}</span>
            </div>
            <div class="detail-row" *ngIf="order.expectedDelivery">
              <mat-icon>local_shipping</mat-icon>
              <span>Expected: {{order.expectedDelivery | date:'mediumDate'}}</span>
            </div>
            <div class="detail-row">
              <mat-icon>inventory</mat-icon>
              <span>{{order.items.length}} item{{order.items.length !== 1 ? 's' : ''}}</span>
            </div>
            <div class="detail-row">
              <mat-icon>attach_money</mat-icon>
              <span class="order-total">${{order.totalAmount.toLocaleString()}}</span>
            </div>
          </div>

          <!-- Order Items Preview -->
          <div class="items-preview">
            <h4>Items:</h4>
            <div class="item-list">
              <div *ngFor="let item of order.items.slice(0, 3)" class="item-preview">
                <span class="item-name">{{item.name}}</span>
                <span class="item-quantity">Qty: {{item.quantity}}</span>
              </div>
              <div *ngIf="order.items.length > 3" class="more-items">
                +{{order.items.length - 3}} more items
              </div>
            </div>
          </div>

          <!-- Progress Indicator -->
          <div class="order-progress">
            <mat-progress-bar [value]="getOrderProgress(order.status)" 
                              [color]="getProgressColor(order.status)">
            </mat-progress-bar>
            <div class="progress-label">{{getProgressLabel(order.status)}}</div>
          </div>
        </mat-card-content>

        <mat-card-actions>
          <button mat-button (click)="viewOrder(order); $event.stopPropagation()">
            <mat-icon>visibility</mat-icon>
            View
          </button>
          <button mat-button (click)="editOrder(order); $event.stopPropagation()" 
                  [disabled]="order.status === 'delivered' || order.status === 'cancelled'">
            <mat-icon>edit</mat-icon>
            Edit
          </button>
          <button mat-icon-button [matMenuTriggerFor]="cardActionMenu" (click)="$event.stopPropagation()">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #cardActionMenu="matMenu">
            <button mat-menu-item (click)="printPO(order)">
              <mat-icon>print</mat-icon>
              <span>Print PO</span>
            </button>
            <button mat-menu-item (click)="trackOrder(order)" [disabled]="!order.trackingNumber">
              <mat-icon>my_location</mat-icon>
              <span>Track Package</span>
            </button>
            <button mat-menu-item (click)="duplicateOrder(order)">
              <mat-icon>content_copy</mat-icon>
              <span>Duplicate Order</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="updateStatus(order, 'confirmed')" 
                    [disabled]="order.status !== 'pending'">
              <mat-icon>check_circle</mat-icon>
              <span>Mark Confirmed</span>
            </button>
            <button mat-menu-item (click)="updateStatus(order, 'shipped')" 
                    [disabled]="order.status !== 'confirmed'">
              <mat-icon>local_shipping</mat-icon>
              <span>Mark Shipped</span>
            </button>
            <button mat-menu-item (click)="updateStatus(order, 'delivered')" 
                    [disabled]="order.status !== 'shipped'">
              <mat-icon>done_all</mat-icon>
              <span>Mark Delivered</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="cancelOrder(order)" 
                    [disabled]="order.status === 'delivered' || order.status === 'cancelled'" 
                    class="delete-action">
              <mat-icon>cancel</mat-icon>
              <span>Cancel Order</span>
            </button>
          </mat-menu>
        </mat-card-actions>
      </mat-card>
    </div>

    <!-- Table View -->
    <mat-card *ngIf="viewMode === 'table'" class="table-container">
      <table mat-table [dataSource]="getFilteredOrders()" class="orders-table">
        <!-- Selection Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox (change)="$event ? toggleAllRows() : null"
                          [checked]="selection.hasValue() && isAllSelected()"
                          [indeterminate]="selection.hasValue() && !isAllSelected()">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let order">
            <mat-checkbox (click)="$event.stopPropagation()"
                          (change)="$event ? selection.toggle(order) : null"
                          [checked]="selection.isSelected(order)">
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- PO Number Column -->
        <ng-container matColumnDef="poNumber">
          <th mat-header-cell *matHeaderCellDef>PO Number</th>
          <td mat-cell *matCellDef="let order">
            <span class="po-number">{{order.poNumber}}</span>
          </td>
        </ng-container>

        <!-- Supplier Column -->
        <ng-container matColumnDef="supplier">
          <th mat-header-cell *matHeaderCellDef>Supplier</th>
          <td mat-cell *matCellDef="let order">
            <div class="supplier-cell">
              <span class="supplier-name">{{order.supplier}}</span>
              <span class="supplier-contact">{{order.supplierContact}}</span>
            </div>
          </td>
        </ng-container>

        <!-- Order Date Column -->
        <ng-container matColumnDef="orderDate">
          <th mat-header-cell *matHeaderCellDef>Order Date</th>
          <td mat-cell *matCellDef="let order">
            <span class="order-date">{{order.orderDate | date:'short'}}</span>
          </td>
        </ng-container>

        <!-- Items Column -->
        <ng-container matColumnDef="items">
          <th mat-header-cell *matHeaderCellDef>Items</th>
          <td mat-cell *matCellDef="let order">
            <span class="items-count">{{order.items.length}} item{{order.items.length !== 1 ? 's' : ''}}</span>
          </td>
        </ng-container>

        <!-- Total Column -->
        <ng-container matColumnDef="total">
          <th mat-header-cell *matHeaderCellDef>Total</th>
          <td mat-cell *matCellDef="let order">
            <span class="order-total">${{order.totalAmount.toLocaleString()}}</span>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let order">
            <mat-chip [class]="getStatusChipClass(order.status)">{{order.status | titlecase}}</mat-chip>
          </td>
        </ng-container>

        <!-- Expected Delivery Column -->
        <ng-container matColumnDef="expectedDelivery">
          <th mat-header-cell *matHeaderCellDef>Expected Delivery</th>
          <td mat-cell *matCellDef="let order">
            <span class="expected-delivery" 
                  [class.overdue]="isOverdue(order.expectedDelivery)">
              {{order.expectedDelivery | date:'mediumDate'}}
            </span>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let order">
            <button mat-icon-button (click)="viewOrder(order)" matTooltip="View Order">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button (click)="editOrder(order)" 
                    [disabled]="order.status === 'delivered' || order.status === 'cancelled'"
                    matTooltip="Edit Order">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button [matMenuTriggerFor]="tableActionMenu" matTooltip="More">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #tableActionMenu="matMenu">
              <button mat-menu-item (click)="printPO(order)">
                <mat-icon>print</mat-icon>
                <span>Print PO</span>
              </button>
              <button mat-menu-item (click)="trackOrder(order)" [disabled]="!order.trackingNumber">
                <mat-icon>my_location</mat-icon>
                <span>Track Package</span>
              </button>
              <button mat-menu-item (click)="duplicateOrder(order)">
                <mat-icon>content_copy</mat-icon>
                <span>Duplicate</span>
              </button>
              <mat-divider></mat-divider>
              <button mat-menu-item (click)="cancelOrder(order)" 
                      [disabled]="order.status === 'delivered' || order.status === 'cancelled'" 
                      class="delete-action">
                <mat-icon>cancel</mat-icon>
                <span>Cancel Order</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="selectOrder(row)"></tr>
      </table>

      <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" 
                     [pageSize]="25" 
                     showFirstLastButtons>
      </mat-paginator>
    </mat-card>
  </div>

  <!-- Empty State -->
  <div *ngIf="getFilteredOrders().length === 0" class="empty-state">
    <mat-icon>shopping_cart</mat-icon>
    <h3>No orders found</h3>
    <p>{{searchTerm ? 'Try adjusting your search criteria' : 'Get started by creating your first order'}}</p>
    <button mat-raised-button color="primary" (click)="openCreateOrderDialog()" *ngIf="!searchTerm">
      <mat-icon>add_shopping_cart</mat-icon>
      Create Order
    </button>
  </div>

  <!-- Bulk Actions Bar -->
  <div class="bulk-actions" *ngIf="selection.hasValue()">
    <span>{{selection.selected.length}} order{{selection.selected.length === 1 ? '' : 's'}} selected</span>
    <div class="bulk-buttons">
      <button mat-raised-button (click)="bulkConfirm()">
        <mat-icon>check_circle</mat-icon>
        Confirm
      </button>
      <button mat-raised-button (click)="bulkPrint()">
        <mat-icon>print</mat-icon>
        Print POs
      </button>
      <button mat-raised-button (click)="bulkExport()">
        <mat-icon>download</mat-icon>
        Export
      </button>
      <button mat-raised-button color="warn" (click)="bulkCancel()">
        <mat-icon>cancel</mat-icon>
        Cancel
      </button>
    </div>
  </div>
</div>
